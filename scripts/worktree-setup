#!/usr/bin/env bash
#
# MiniNAS Worktree Setup
#
# Set up a new worktree with node_modules, env files, and data from the main worktree.
#
# Usage: ./scripts/worktree-setup [source_worktree]
#
# If source_worktree is not specified, it will use the main worktree.
#
# Symlinked (avoids reinstall):
#   node_modules, .mininas/thumbnails
#
# Copied (env files):
#   .env
#
# Linked (shared state):
#   data/mininas.db (SQLite database)

set -e

get_main_worktree() {
  git worktree list | head -1 | awk '{print $1}'
}

CURRENT_WORKTREE="$(git rev-parse --show-toplevel)"
SOURCE_WORKTREE="${1:-$(get_main_worktree)}"

if [ -z "$SOURCE_WORKTREE" ]; then
  echo "Error: Could not determine source worktree. Please specify it as an argument."
  exit 1
fi

if [ "$SOURCE_WORKTREE" = "$CURRENT_WORKTREE" ]; then
  echo "Error: Source and destination worktrees are the same."
  exit 1
fi

if [ ! -d "$SOURCE_WORKTREE" ]; then
  echo "Error: Source worktree does not exist: $SOURCE_WORKTREE"
  exit 1
fi

echo "==> Setting up MiniNAS worktree"
echo "    Source: $SOURCE_WORKTREE"
echo "    Target: $CURRENT_WORKTREE"
echo ""

# ── 1. Symlink node_modules ──────────────────────────────────────────
symlink_dir() {
  local rel_path="$1"
  local src="$SOURCE_WORKTREE/$rel_path"
  local dst="$CURRENT_WORKTREE/$rel_path"

  if [ -d "$src" ] && [ ! -e "$dst" ]; then
    mkdir -p "$(dirname "$dst")"
    ln -s "$src" "$dst"
    echo "    Linked $rel_path"
  fi
}

echo "==> Linking node_modules"
symlink_dir "node_modules"
symlink_dir "packages/api/node_modules"
symlink_dir "packages/web/node_modules"
echo ""

# ── 2. Copy .env ─────────────────────────────────────────────────────
if [ ! -f "$CURRENT_WORKTREE/.env" ]; then
  if [ -f "$SOURCE_WORKTREE/.env" ]; then
    cp "$SOURCE_WORKTREE/.env" "$CURRENT_WORKTREE/.env"
    echo "==> Copied .env from source worktree"
  elif [ -f "$CURRENT_WORKTREE/.env.example" ]; then
    cp "$CURRENT_WORKTREE/.env.example" "$CURRENT_WORKTREE/.env"
    echo "==> Created .env from .env.example (edit as needed)"
  fi
else
  echo "==> .env already exists, skipping"
fi
echo ""

# ── 3. Ensure data/cache directories exist ───────────────────────────
echo "==> Creating data directories"
mkdir -p "$CURRENT_WORKTREE/packages/api/data"
mkdir -p "$CURRENT_WORKTREE/.mininas/thumbnails"
mkdir -p "$CURRENT_WORKTREE/.mininas/uploads"
echo ""

# ── 4. Symlink the SQLite database (shared across worktrees) ────────
DB_SRC="$SOURCE_WORKTREE/packages/api/data/mininas.db"
DB_DST="$CURRENT_WORKTREE/packages/api/data/mininas.db"
if [ -f "$DB_SRC" ] && [ ! -e "$DB_DST" ]; then
  ln -s "$DB_SRC" "$DB_DST"
  echo "==> Linked shared database"
elif [ ! -e "$DB_DST" ]; then
  echo "==> No existing database found (one will be created on first run)"
fi
echo ""

# ── 5. Symlink thumbnail cache ───────────────────────────────────────
THUMB_SRC="$SOURCE_WORKTREE/.mininas/thumbnails"
THUMB_DST="$CURRENT_WORKTREE/.mininas/thumbnails"
if [ -d "$THUMB_SRC" ] && [ ! -L "$THUMB_DST" ]; then
  rm -rf "$THUMB_DST" 2>/dev/null || true
  ln -s "$THUMB_SRC" "$THUMB_DST"
  echo "==> Linked thumbnail cache"
fi
echo ""

# ── 6. Symlink build caches ──────────────────────────────────────────
echo "==> Linking build caches"
cd "$SOURCE_WORKTREE"
while IFS= read -r dir; do
  rel_path="${dir#./}"
  symlink_dir "$rel_path"
done < <(find . -type d -name ".turbo" -prune 2>/dev/null)
echo ""

# ── Done ─────────────────────────────────────────────────────────────
echo "==> Worktree ready!"
echo ""
echo "    Start dev servers:"
echo "      pnpm dev"
echo ""
echo "    Or run individually:"
echo "      pnpm --filter @mininas/api dev    # API on :3001"
echo "      pnpm --filter @mininas/web dev    # Web on :4321"
echo ""
