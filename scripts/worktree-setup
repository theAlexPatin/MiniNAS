#!/usr/bin/env bash
#
# MiniNAS Worktree Setup
#
# Set up a new worktree with node_modules, env files, and data from the main worktree.
#
# Usage: ./scripts/worktree-setup [source_worktree]
#
# If source_worktree is not specified, it will use the main worktree.
#
# Symlinked (avoids reinstall):
#   node_modules
#
# Copied (env files):
#   .env
#
# Shared via ~/.mininas/data/ (no symlinks needed):
#   mininas.db, thumbnails, uploads

set -e

get_main_worktree() {
  git worktree list | head -1 | awk '{print $1}'
}

CURRENT_WORKTREE="$(git rev-parse --show-toplevel)"
SOURCE_WORKTREE="${1:-$(get_main_worktree)}"

# ── 0. Pull latest base branch in the source worktree ────────────────
echo "==> Pulling latest changes in source worktree"
git -C "$SOURCE_WORKTREE" fetch origin 2>/dev/null || true
DEFAULT_BRANCH="$(git -C "$SOURCE_WORKTREE" symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')"
if [ -n "$DEFAULT_BRANCH" ]; then
  git -C "$SOURCE_WORKTREE" pull origin "$DEFAULT_BRANCH" --ff-only 2>/dev/null || true
  echo "    Pulled origin/$DEFAULT_BRANCH"
fi
echo ""

if [ -z "$SOURCE_WORKTREE" ]; then
  echo "Error: Could not determine source worktree. Please specify it as an argument."
  exit 1
fi

if [ "$SOURCE_WORKTREE" = "$CURRENT_WORKTREE" ]; then
  echo "Error: Source and destination worktrees are the same."
  exit 1
fi

if [ ! -d "$SOURCE_WORKTREE" ]; then
  echo "Error: Source worktree does not exist: $SOURCE_WORKTREE"
  exit 1
fi

echo "==> Setting up MiniNAS worktree"
echo "    Source: $SOURCE_WORKTREE"
echo "    Target: $CURRENT_WORKTREE"
echo ""

# ── 1. Symlink node_modules ──────────────────────────────────────────
symlink_dir() {
  local rel_path="$1"
  local src="$SOURCE_WORKTREE/$rel_path"
  local dst="$CURRENT_WORKTREE/$rel_path"

  if [ ! -d "$src" ]; then
    return
  fi

  # Remove existing real directory (not a symlink) before linking
  if [ -d "$dst" ] && [ ! -L "$dst" ]; then
    rm -rf "$dst"
    echo "    Removed existing $rel_path"
  fi

  if [ ! -e "$dst" ]; then
    mkdir -p "$(dirname "$dst")"
    ln -s "$src" "$dst"
    echo "    Linked $rel_path"
  fi
}

echo "==> Linking node_modules"
symlink_dir "node_modules"
symlink_dir "packages/api/node_modules"
symlink_dir "packages/web/node_modules"
echo ""

# ── 2. Copy .env ─────────────────────────────────────────────────────
if [ ! -f "$CURRENT_WORKTREE/.env" ]; then
  if [ -f "$SOURCE_WORKTREE/.env" ]; then
    cp "$SOURCE_WORKTREE/.env" "$CURRENT_WORKTREE/.env"
    echo "==> Copied .env from source worktree"
  elif [ -f "$CURRENT_WORKTREE/.env.example" ]; then
    cp "$CURRENT_WORKTREE/.env.example" "$CURRENT_WORKTREE/.env"
    echo "==> Created .env from .env.example (edit as needed)"
  fi
else
  echo "==> .env already exists, skipping"
fi
echo ""

# ── 3. Ensure shared data directory exists ────────────────────────────
echo "==> Ensuring ~/.mininas/data exists"
mkdir -p "$HOME/.mininas/data/thumbnails"
mkdir -p "$HOME/.mininas/data/uploads"
echo "    All worktrees share ~/.mininas/data/ by default"
echo ""

# ── 4. Symlink build caches ──────────────────────────────────────────
echo "==> Linking build caches"
cd "$SOURCE_WORKTREE"
while IFS= read -r dir; do
  rel_path="${dir#./}"
  symlink_dir "$rel_path"
done < <(find . -type d -name ".turbo" -prune 2>/dev/null)
echo ""

# ── Done ─────────────────────────────────────────────────────────────
echo "==> Worktree ready!"
echo ""
echo "    Start dev servers:"
echo "      pnpm dev"
echo ""
echo "    Or run individually:"
echo "      pnpm --filter @mininas/api dev    # API on :3001"
echo "      pnpm --filter @mininas/web dev    # Web on :4321"
echo ""
